@page "/"
@using Taskboard.Entities.Task
@using Taskboard.Models.DTO
@using Taskboard.Services.Task
@using Taskboard.Services.Update
@using TaskStatus = Taskboard.Entities.Task.TaskStatus
@inject TaskService taskservice
@inject UpdateService updateservice




<MudDropContainer T="ReadTaskDTO" Items="allTasks" ItemsSelector="@((ReadTaskDTO task, string dropzone) => task.TaskStatus.ToString() == dropzone)" ItemDropped="TaskMoved" Style="display:flex; flex-direction: row; width: 100%; height: 100%;">
    <ChildContent>
        <MudDropZone T="ReadTaskDTO" Identifier="ToDo" AllowReorder="true" Style="margin: 2%; display: flex; flex-direction: column; width: 30%; text-align: center; min-height: 100vh;  border: 2px solid #f6f5f3; border-radius: 5px;" CanDrop="((task) => task.TaskStatus is TaskStatus.InProgress or TaskStatus.ToDo )">
            <MudText Typo="Typo.h4" Style="margin-top : 2%; margin-bottom: 2%; color: #d3d3d3;">ToDo</MudText>
        </MudDropZone>

        <MudDropZone T="ReadTaskDTO" CanDrop="((task) => task.TaskStatus is TaskStatus.ToDo or TaskStatus.InProgress or TaskStatus.Done)" Identifier="InProgress" AllowReorder="true" Style="margin: 2%; display: flex; flex-direction: column; width: 30%; text-align: center; min-height: 100vh; border: 2px solid #f6f5f3; border-radius: 5px;">
            <MudText Typo="Typo.h4" Style="margin-top : 2%; margin-bottom: 2%; color: #d3d3d3;">In Progress</MudText>
        </MudDropZone>

        <MudDropZone T="ReadTaskDTO" Identifier="Done" AllowReorder="true" Style="margin: 2%; display: flex; flex-direction: column; width: 30%; text-align: center; min-height: 100vh; border: 2px solid #f6f5f3; border-radius: 5px;" CanDrop="((task) => task.TaskStatus is TaskStatus.InProgress or TaskStatus.Done)">
            <MudText Typo="Typo.h4" Style="margin-top : 2%; margin-bottom: 2%; color: #d3d3d3;">Done</MudText>
        </MudDropZone>
    </ChildContent>
    <ItemRenderer>
        <TaskCard CardTaskItem="@context" />
    </ItemRenderer>
</MudDropContainer>
@code {

    private List<ReadTaskDTO> allTasks = new();

    private async Task TaskMoved(MudItemDropInfo<ReadTaskDTO> task)
    {
        
        if (task.DropzoneIdentifier == nameof(TaskStatus.ToDo))
        {
            task.Item.TaskStatus = TaskStatus.ToDo;
        }else if (task.DropzoneIdentifier == nameof(TaskStatus.InProgress))
        {
            task.Item.TaskStatus = TaskStatus.InProgress;
        }else if (task.DropzoneIdentifier == nameof(TaskStatus.Done))
        {
            task.Item.TaskStatus = TaskStatus.Done;
        }

        UpdateTaskDTO dto = new UpdateTaskDTO()
        {
            Id = task.Item.Id,
            Title = task.Item.Title,
            Description = task.Item.Description,
            TaskStatus = task.Item.TaskStatus,
            
        };
        
        await taskservice.UpdateTaskAsync(dto);
        

    }

    private async void UpdateTasks()
    {
        await LoadTasks();
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadTasks();
        updateservice.UpdateRequested += UpdateTasks;
    }

    private async Task<List<ReadTaskDTO>> LoadTasks()
    {
        allTasks = await taskservice.GetAllTasksAsync();
        return allTasks;
    }
    
}